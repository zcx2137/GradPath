{% extends 'students/base.html' %}
{% load static %}

{% block title %}保研加分小助手{% endblock %}

{% block extra_css %}
    <link href="{% static 'CSS/students/student_dashboard.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

    <div class="container">
        <div class="main-content">
            <!-- 页面标题和用户信息 -->
            <div class="page-header">
                <h1 class="page-title">保研加分小助手</h1>
                <div class="user-info">
                    <span class="username">{{ user.username|default:"用户名" }}</span>
                </div>
            </div>

            <!-- 功能卡片网格 -->
            <div class="features-grid">
                <!-- 成绩排名 -->
                <a href="{% url 'ranking' %}" class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="feature-title">成绩排名</h3>
                    <p class="feature-description">查看当前成绩排名和综合评分情况</p>
                </a>

                <!-- 新增加分项目 -->
                <a href="{% url 'upload' %}" class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h3 class="feature-title">新增加分项目</h3>
                    <p class="feature-description">提交新的加分项目申请</p>
                </a>

                <!-- 我的申请详情 -->
                <a href="{% url 'submissions' %}" class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h3 class="feature-title">我的申请详情</h3>
                    <p class="feature-description">查看和管理已提交的申请</p>
                </a>

                <!-- 查看加分细则 -->
                <a href="{% url 'rules' %}" class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 class="feature-title">查看加分细则</h3>
                    <p class="feature-description">了解各项加分规则和标准</p>
                </a>
            </div>

            <!-- 动态信息列表区 -->
            <div class="dynamic-section">
                <div class="section-header">
                    <h2 class="section-title">最新通知（共{{ notifications|length }}条通知）</h2>
                    <a href="{% url 'notifications' %}" class="view-all">
                        查看全部 <i class="fas fa-chevron-right"></i>
                    </a>
                </div>

                <!-- 通知滚动容器 -->
                <div class="notification-scroll-container">
                    <div class="notification-list" id="notificationScrollContent">
                        {% for notification in notifications %}
                        <div class="notification-item {% if not notification.is_read %}unread{% endif %}">
                            <div class="notification-header">
                                <div class="notification-type">
                                    {% if notification.type == 'submission' %}
                                        <i class="fas fa-file-alt"></i>
                                        <span>审核通知</span>
                                    {% elif notification.type == 'rule' %}
                                        <i class="fas fa-cog"></i>
                                        <span>规则更新</span>
                                    {% else %}
                                        <i class="fas fa-bullhorn"></i>
                                        <span>系统通知</span>
                                    {% endif %}
                                </div>
                                <div class="notification-time">
                                    {{ notification.created_at|date:"Y-m-d H:i" }}
                                </div>
                            </div>
                            <div class="notification-content">
                                <h4>{{ notification.title }}</h4>
                                <p>{{ notification.content|truncatechars:50 }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-notification">
                            <i class="fas fa-bell-slash"></i>
                            <p>暂无新通知</p>
                        </div>
                        {% endfor %}

                        <!-- 复制两份用于无缝滚动 -->
                        {% for notification in notifications %}
                        <div class="notification-item {% if not notification.is_read %}unread{% endif %}">
                            <div class="notification-header">
                                <div class="notification-type">
                                    {% if notification.type == 'submission' %}
                                        <i class="fas fa-file-alt"></i>
                                        <span>审核通知</span>
                                    {% elif notification.type == 'rule' %}
                                        <i class="fas fa-cog"></i>
                                        <span>规则更新</span>
                                    {% else %}
                                        <i class="fas fa-bullhorn"></i>
                                        <span>系统通知</span>
                                    {% endif %}
                                </div>
                                <div class="notification-time">
                                    {{ notification.created_at|date:"Y-m-d H:i" }}
                                </div>
                            </div>
                            <div class="notification-content">
                                <h4>{{ notification.title }}</h4>
                                <p>{{ notification.content|truncatechars:50 }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    
                    
                    </div>
                </div>
            </div>


        </div>
    </div>

    <br>
    <a href="{% url 'root' %}"><span>退出登录（暂放此处）</span></a>
    
    <script>
    const container = document.getElementById('notificationScrollContainer');
    const content = document.getElementById('notificationScrollContent');
    
    // 滚动速度（像素/秒）
    const scrollSpeed = 100; 
    // 单条数据滚动间隔（毫秒）
    const itemPause = 3000;
    // 初始静止时间（毫秒）
    const initialDelay = 5000; // 5秒
    
    // 获取单个通知项高度（包含间距）
    const itemElements = document.querySelectorAll('.notification-item');
    const itemHeight = itemElements.length > 0 ? (itemElements[0].offsetHeight + 16) : 0; // 16是通知项间距
    // 原始数据数量（除以2是因为有复制的内容）
    const itemCount = Math.ceil(itemElements.length / 2);
    
    let scrollPosition = 0;
    let isPausing = false;
    let accumulatedScroll = 0;
    let isScrolling = false; // 控制是否启动滚动
    
    // 滚动动画函数
    function scrollAnimation() {
        if (isScrolling && itemHeight > 0) { // 只有启动后且有内容才执行滚动
            if (!isPausing) {
                const delta = scrollSpeed / 60;
                scrollPosition -= delta;
                accumulatedScroll += delta;
                content.style.transform = `translateY(${scrollPosition}px)`;
    
                // 减速逻辑
                if (accumulatedScroll + delta >= itemHeight) {
                    const remaining = itemHeight - accumulatedScroll;
                    scrollPosition -= remaining;
                    accumulatedScroll = itemHeight;
                }
    
                // 触发停顿
                if (accumulatedScroll >= itemHeight) {
                    isPausing = true;
                    accumulatedScroll = 0;
                    setTimeout(() => {
                        isPausing = false;
                    }, itemPause);
                }
    
                // 循环重置
                if (Math.abs(scrollPosition) >= itemHeight * itemCount) {
                    scrollPosition = 0;
                    content.style.transform = `translateY(0)`;
                }
            }
        }
        requestAnimationFrame(scrollAnimation);
    }
    
    // 启动滚动动画
    scrollAnimation();
    
    // 延迟启动滚动
    setTimeout(() => {
        isScrolling = true;
    }, initialDelay);
    
    // 鼠标悬停暂停滚动
    container.addEventListener('mouseenter', () => {
        isScrolling = false;
    });
    
    // 鼠标离开继续滚动
    container.addEventListener('mouseleave', () => {
        if (itemCount > 3) { // 只有当内容超过一屏时才继续滚动
            isScrolling = true;
        }
    });
    </script>    
    
{% endblock %}