{% extends 'admins/base.html' %}

{% load static %}

{% block extra_css %}
    <link href="{% static 'CSS/admins/dashboard.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% endblock %}

{% block content %}
        
    <!-- 搜索表单 -->
    <div class="filter-form" style="margin: 20px 0;">
        <form method="get" action="{% url 'admin_dashboard' %}">
            {# 学院筛选 #}
            <select name="college" style="padding: 8px; margin-right: 10px;">
                <option value="">所有学院</option>
                {% for code, name in college_choices %}
                    <option value="{{ code }}" {% if current_college == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                {% endfor %}
            </select>

            {# 年级筛选 #}
            <select name="grade" style="padding: 8px; margin-right: 10px;">
                <option value="">所有年级</option>
                {% for grade in grade_choices %}
                    <option value="{{ grade }}" {% if current_grade == grade %}selected{% endif %}>
                        {{ grade }}
                    </option>
                {% endfor %}
            </select>

            <button type="submit" style="padding: 8px 16px; background: #4a90e2; color: white; border: none; border-radius: 4px;">
                筛选
            </button>
            <a href="{% url 'admin_dashboard' %}" style="margin-left: 10px; color: #666;">重置</a>
        </form>
    </div>
    
    <h2>学生账号列表</h2>
    <!-- 批量操作区 -->
    <div class="batch-operations">
        <button id="selectAllStudents" class="btn btn-select">全选学生</button>
        <button id="deselectAllStudents" class="btn btn-select">反选学生</button>
        <select id="selectStudentGrade" class="grade-select">
            <option value="">选择年级批量选择</option>
            {% for grade in grade_choices %}
                <option value="{{ grade }}">{{ grade }}级</option>
            {% endfor %}
        </select>
        <button id="batchDeleteStudents" class="btn btn-delete" onclick="confirmBatchDelete('student')">批量删除选中学生</button>
    </div>    
    <!-- 学生搜索表单 -->
    <div class="search-container">
        <form method="get" class="search-form">
            <!-- 保留当前筛选条件（学院/年级） -->
            <input type="hidden" name="college" value="{{ current_college }}">
            <input type="hidden" name="grade" value="{{ current_grade }}">
            
            <input type="text" 
                   name="student_search" 
                   placeholder="搜索学生姓名或学号..." 
                   value="{{ student_search }}">
            <button type="submit" class="search-btn">搜索</button>
            {% if student_search %}
                <!-- 清除学生搜索时保留其他参数 -->
                <a href="?college={{ current_college }}&grade={{ current_grade }}" class="clear-search">清除</a>
            {% endif %}
        </form>
    </div>
    <!-- 学生列表 -->
    <table class="user-table">
        <tr>
            <th>选择</th>
            <th>序号</th>
            <th>
                <div class="sort-control">
                    <span>学号</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&student_search={{ student_search }}&sort=student_id{% if current_sort == 'student_id' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'student_id' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>
                <div class="sort-control">
                    <span>姓名</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&student_search={{ student_search }}&sort=full_name{% if current_sort == 'full_name' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'full_name' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>用户名</th>
            <th>
                <div class="sort-control">
                    <span>学院</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&student_search={{ student_search }}&sort=college{% if current_sort == 'college' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'college' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>
                <div class="sort-control">
                    <span>年级</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&student_search={{ student_search }}&sort=grade{% if current_sort == 'grade' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'grade' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-numeric-asc{% else %}fa-sort-numeric-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>操作</th>
        </tr>
        {% for student in students %}
        <tr>
            <td><input type="checkbox" class="student-checkbox" data-id="{{ student.user.id }}" data-grade="{{ student.grade }}"></td>
            <td>{{ forloop.counter }}</td>  <!-- 动态序号，筛选后自动重置 -->
            <td>{{ student.student_id }}</td>
            <td>{{ student.full_name }}</td>
            <td>{{ student.user.username }}</td>
            <td>{{ student.get_college_display }}</td>
            <td>{{ student.grade }}</td>
            <td>
                <!-- 操作按钮保持不变 -->
                <a href="{% url 'edit_user' student.user.id %}" class="btn btn-edit">编辑</a>
                <a href="{% url 'reset_password' student.user.id %}" class="btn btn-reset" 
                   onclick="return confirm('确定要重置密码吗？')">重置密码</a>
                <a href="{% url 'delete_user' student.user.id %}" class="btn btn-delete" 
                   onclick="return confirm('确定要删除吗？')">删除</a>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">暂无学生数据</td></tr>  <!-- 注意colspan数量变化 -->
        {% endfor %}
    </table>

    <h2>辅导员账号列表</h2>
    <!-- 批量操作区 -->
    <div class="batch-operations">
        <button id="selectAllCounselors" class="btn btn-select">全选辅导员</button>
        <button id="deselectAllCounselors" class="btn btn-select">反选辅导员</button>
        <select id="selectCounselorGrade" class="grade-select">
            <option value="">选择负责年级批量选择</option>
            {% for grade in grade_choices %}
                <option value="{{ grade }}">{{ grade }}级</option>
            {% endfor %}
        </select>
        <button id="batchDeleteCounselors" class="btn btn-delete" onclick="confirmBatchDelete('counselor')">批量删除选中辅导员</button>
    </div>    
    <!-- 辅导员搜索表单 -->
    <div class="search-container">
        <form method="get" class="search-form">
            <!-- 保留当前筛选条件（学院/年级） -->
            <input type="hidden" name="college" value="{{ current_college }}">
            <input type="hidden" name="grade" value="{{ current_grade }}">
            
            <input type="text" 
                   name="counselor_search" 
                   placeholder="搜索辅导员姓名或工号..." 
                   value="{{ counselor_search }}">
            <button type="submit" class="search-btn">搜索</button>
            {% if counselor_search %}
                <!-- 清除辅导员搜索时保留其他参数 -->
                <a href="?college={{ current_college }}&grade={{ current_grade }}" class="clear-search">清除</a>
            {% endif %}
        </form>
    </div> 
    <!-- 辅导员列表 -->
    <table class="user-table">
        <tr>
            <th>选择</th>
            <th>序号</th>
            <th>
                <div class="sort-control">
                    <span>工号</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&counselor_search={{ counselor_search }}&sort=employee_id{% if current_sort == 'employee_id' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'employee_id' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>
                <div class="sort-control">
                    <span>姓名</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&counselor_search={{ counselor_search }}&sort=full_name{% if current_sort == 'full_name' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'full_name' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>用户名</th>
            <th>
                <div class="sort-control">
                    <span>学院</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&counselor_search={{ counselor_search }}&sort=college{% if current_sort == 'college' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'college' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-amount-asc{% else %}fa-sort-amount-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>
                <div class="sort-control">
                    <span>负责年级</span>
                    <button type="button" class="sort-btn" onclick="window.location='?college={{ current_college }}&grade={{ current_grade }}&counselor_search={{ counselor_search }}&sort=grade{% if current_sort == 'grade' and sort_dir == 'asc' %}&dir=desc{% else %}&dir=asc{% endif %}'">
                        <i class="fa {% if current_sort != 'grade' %}fa-sort{% elif sort_dir == 'asc' %}fa-sort-numeric-asc{% else %}fa-sort-numeric-desc{% endif %}"></i>
                    </button>
                </div>
            </th>
            <th>操作</th>
        </tr>
        {% for counselor in counselors %}
        <tr>
            <td><input type="checkbox" class="counselor-checkbox" data-id="{{ counselor.user.id }}" data-grade="{{ counselor.grade }}"></td>
            <td>{{ forloop.counter }}</td>  <!-- 动态序号 -->
            <td>{{ counselor.employee_id }}</td>
            <td>{{ counselor.full_name }}</td>
            <td>{{ counselor.user.username }}</td>
            <td>{{ counselor.get_college_display }}</td>
            <td>{{ counselor.grade }}</td>
            <td>
                <!-- 操作按钮保持不变 -->
                <a href="{% url 'edit_user' counselor.user.id %}" class="btn btn-edit">编辑</a>
                <a href="{% url 'reset_password' counselor.user.id %}" class="btn btn-reset" 
                   onclick="return confirm('确定要重置密码吗？')">重置密码</a>
                <a href="{% url 'delete_user' counselor.user.id %}" class="btn btn-delete"
                   onclick="return confirm('确定要删除吗？')">删除</a>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">暂无辅导员数据</td></tr>  <!-- 注意colspan数量变化 -->
        {% endfor %}
    </table>
    
    <!-- 批量删除确认模态框 -->
    <div id="batchDeleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <p>确定要删除选中的 <span id="deleteCount">0</span> 个账号吗？此操作不可恢复！</p>
            <form id="batchDeleteForm" method="post" action="{% url 'batch_delete_users' %}">
                {% csrf_token %}
                <input type="hidden" name="user_type" id="batchUserType">
                <input type="hidden" name="user_ids" id="batchUserIds">
                <button type="submit" class="btn btn-confirm">确认删除</button>
                <button type="button" class="btn btn-cancel" onclick="hideModal()">取消</button>
            </form>
        </div>
    </div>

    <script>
    // 全选学生
    document.getElementById('selectAllStudents').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = true);
    });
    
    // 反选学生
    document.getElementById('deselectAllStudents').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = !checkbox.checked;  // 取反当前选中状态
        });
    });
    
    // 按年级选择学生
    document.getElementById('selectStudentGrade').addEventListener('change', function() {
        const grade = this.value;
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = grade ? checkbox.getAttribute('data-grade') === grade : false;
        });
    });
    
    // 全选辅导员
    document.getElementById('selectAllCounselors').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.counselor-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = true);
    });
    
    // 反选辅导员
    document.getElementById('deselectAllCounselors').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.counselor-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = !checkbox.checked;  // 取反当前选中状态
        });
    });
    
    // 按年级选择辅导员
    document.getElementById('selectCounselorGrade').addEventListener('change', function() {
        const grade = this.value;
        const checkboxes = document.querySelectorAll('.counselor-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = grade ? checkbox.getAttribute('data-grade') === grade : false;
        });
    });
    
    // 显示确认删除模态框
    function confirmBatchDelete(userType) {
        const checkboxes = document.querySelectorAll(`.${userType}-checkbox:checked`);
        const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
        
        if (ids.length === 0) {
            alert('请先选择要删除的账号');
            return;
        }
        
        document.getElementById('deleteCount').textContent = ids.length;
        document.getElementById('batchUserType').value = userType;
        document.getElementById('batchUserIds').value = ids.join(',');
        document.getElementById('batchDeleteModal').style.display = 'block';
    }
    
    // 隐藏模态框
    function hideModal() {
        document.getElementById('batchDeleteModal').style.display = 'none';
    }
    </script>
    
{% endblock %}